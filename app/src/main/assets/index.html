<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chord Rain V4.3: Safe UI</title>
    <!-- Referenced locally for offline support -->
    <script src="tailwind.min.js"></script>
    <style>
        body {
            touch-action: pan-y; 
            background-color: #050505;
            color: #e5e5e5;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden; 
            user-select: none;
        }

        /* --- GAME CANVAS --- */
        #gameContainer {
            position: relative; width: 100%; height: 50vh; 
            background: linear-gradient(to bottom, #111, #000);
            border-bottom: 0.5vh solid #333; overflow: hidden;
            display: grid; grid-template-columns: 1fr 1fr 1fr;
        }
        
        .col-divider { border-right: 1px dashed rgba(255,255,255,0.05); height: 100%; }

        #particles { position: absolute; inset: 0; pointer-events: none; z-index: 20; }
        .particle { position: absolute; width: 1.5vmin; height: 1.5vmin; border-radius: 50%; pointer-events: none; }

        .falling-chord {
            position: absolute; 
            width: 30vw; height: 10vmin;
            background: #4ade80; border-radius: 1.5vmin;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            box-shadow: 0 0.5vmin 2vmin rgba(0,0,0, 0.5);
            z-index: 10; transition: background-color 0.2s, border-color 0.2s; 
            left: 0; 
        }
        @keyframes flashRed {
            0% { background-color: #ef4444; box-shadow: 0 0 1vmin #ef4444; }
            50% { background-color: #7f1d1d; box-shadow: 0 0 2vmin #ef4444; }
            100% { background-color: #ef4444; box-shadow: 0 0 1vmin #ef4444; }
        }
        .falling-chord.danger { animation: flashRed 0.2s infinite; border: 0.4vmin solid white; }

        .chord-name { font-weight: 900; font-size: 5vmin; color: white; text-shadow: 0 0.4vmin 0.8vmin rgba(0,0,0,0.8); letter-spacing: -1px; line-height: 1; }
        .chord-progress { font-size: 3vmin; color: rgba(255,255,255,0.9); margin-top: -0.5vmin; letter-spacing: 0.5vmin; font-weight: bold; }

        /* --- CONTROLS --- */
        #controlsContainer {
            height: 50vh; 
            background: #1a1a1a; 
            display: flex; flex-direction: column; justify-content: center;
            box-shadow: inset 0 1vmin 2vmin rgba(0,0,0,0.5);
            position: relative;
            padding-bottom: 8vh; 
            padding-top: 1vh;
        }

        /* GRID MODE */
        .note-grid {
            display: grid; grid-template-columns: repeat(4, 1fr); grid-template-rows: repeat(2, 1fr);
            gap: 1.5vmin; height: 100%; max-width: 80vh; margin: 0 auto; width: 100%; padding: 1vmin;
        }
        .note-btn {
            position: relative; background: #262626; border: 0.4vmin solid #404040; border-radius: 2vmin;
            color: #d4d4d4; font-weight: bold; font-size: 4vmin;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: all 0.05s; box-shadow: 0 0.8vmin 0 #171717;
        }
        .note-btn:active, .note-btn.pressed {
            transform: translateY(0.8vmin); box-shadow: 0 0 0 #171717;
            background: #3b82f6; border-color: #60a5fa; color: white;
        }
        .note-btn.span-2 { grid-column: span 2; }

        /* PIANO KEYS MODE */
        #keyboardContainer {
            display: flex;
            width: 100%; height: 100%;
            overflow-x: auto; 
            overflow-y: hidden;
            position: relative;
            background: #000;
            padding-bottom: 2vmin;
        }
        #keyboardContainer::-webkit-scrollbar { display: none; }
        
        .piano-wrapper {
            display: flex; position: relative; height: 100%; min-width: 140vmin;
            padding: 0 2vmin;
        }

        .white-key {
            flex: 1; height: 90%; 
            background: white; 
            border: 1px solid #ccc; border-radius: 0 0 1vmin 1vmin;
            margin: 0 0.2vmin; position: relative; z-index: 1;
            display: flex; align-items: flex-end; justify-content: center;
            padding-bottom: 4vmin; 
            color: #333; font-weight: bold; font-size: 3vmin;
            box-shadow: inset 0 -1vmin 2vmin rgba(0,0,0,0.1);
        }
        .white-key:active, .white-key.pressed { background: #93c5fd; transform: scale(0.98); transform-origin: top; }

        .black-key {
            position: absolute; top: 0; width: 80%; height: 55%; 
            background: #111; border-radius: 0 0 1vmin 1vmin;
            z-index: 10; box-shadow: 0 0.5vmin 1vmin rgba(0,0,0,0.5);
            display: flex; align-items: flex-end; justify-content: center;
            padding-bottom: 1.5vmin; color: #888; font-size: 2vmin; font-weight: bold;
            border: 1px solid #333; border-top: none;
            left: 60%;
        }
        .black-key:active, .black-key.pressed { background: #2563eb; color:white; }

        .hint-badge {
            position: absolute; top: 1vmin;
            width: 3.5vmin; height: 3.5vmin;
            background: #fbbf24; color: black; font-size: 2vmin; font-weight: bold;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 0.4vmin 0.8vmin rgba(0,0,0,0.5); animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 20;
        }
        .white-key .hint-badge { top: auto; bottom: 8vmin; }
        .black-key .hint-badge { top: auto; bottom: 5vmin; }
        
        @keyframes popIn { 0% { transform: scale(0); } 100% { transform: scale(1); } }

        /* --- HUD --- */
        .hud {
            position: absolute; top: 1vmin; width: 100%;
            display: flex; justify-content: space-between; padding: 0 2vmin; z-index: 30; pointer-events: none;
        }
        .hearts { font-size: 4vmin; color: #ef4444; filter: drop-shadow(0 0.2vmin 0.2vmin black); }
        .score { font-size: 5vmin; font-weight: black; color: #fbbf24; text-shadow: 0 0.2vmin 0.4vmin black; font-family: monospace; }
        .combo-box {
            font-size: 3vmin; font-weight: bold; color: #a3e635; text-transform: uppercase; letter-spacing: 0.2vmin;
            opacity: 0; transition: opacity 0.2s;
        }
        .combo-box.active { opacity: 1; }
        .high-score { font-size: 2.5vmin; color: #666; font-family: monospace; letter-spacing: 0.2vmin;}

        #pauseBtn {
            position: absolute; top: 1vmin; left: 50%; transform: translateX(-50%);
            background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);
            color: white; padding: 0.5vmin 2vmin; border-radius: 4vmin; font-size: 2.5vmin;
            pointer-events: auto; cursor: pointer; z-index: 40;
        }

        /* --- OVERLAYS --- */
        .overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.96);
            display: flex; flex-direction: column; align-items: center; 
            z-index: 100; backdrop-filter: blur(5px);
            justify-content: flex-start; padding-top: 2vh; gap: 1.5vh;
        }
        
        #startScreen { overflow-y: auto; padding-bottom: 50px; -webkit-overflow-scrolling: touch; }
        .setup-container { width: 100%; max-width: 600px; padding: 0 4vw; display: flex; flex-direction: column; gap: 1.5vh; align-items: center; }
        .setup-label { margin-bottom: 0.5vh; font-size: 2.5vmin; color: #6b7280; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; }
        .key-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 2vw; width: 100%; }
        .key-select-btn {
            aspect-ratio: 1 / 1; font-size: 6vmin;
            background: #262626; border: 0.3vmin solid #404040; color: #888;
            border-radius: 2vmin; font-weight: bold; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        .key-select-btn.selected { background: #3b82f6; color: white; border-color: #60a5fa; box-shadow: 0 0 1.5vmin #3b82f6; }
        .mode-toggle { display: flex; gap: 0; border-radius: 2vmin; overflow: hidden; border: 0.3vmin solid #404040; width: 100%; height: 6vh; }
        .mode-btn {
            flex: 1; background: #262626; border: none;
            color: #888; font-weight: bold; cursor: pointer; 
            font-size: 3vmin; display: flex; align-items: center; justify-content: center;
            transition: background 0.2s; height: 100%;
        }
        .mode-btn.selected { background: #10b981; color: white; }
        
        #btnMajor.selected, #btnMinor.selected { background: #3b82f6; }
        #btnSlow.selected, #btnFast.selected { background: #10b981; }
        #btnHintsOn.selected, #btnHintsOff.selected { background: #10b981; }
        #btnSimple.selected, #btnFull.selected { background: #8b5cf6; } 
        #btnTriad.selected, #btn7th.selected { background: #f43f5e; } 
        #btnInputButtons.selected, #btnInputKeys.selected { background: #0ea5e9; }

        .start-btn {
            width: 100%; height: 8vh; background: white; color: black; font-weight: 900;
            border-radius: 3vh; font-size: 4vh; cursor: pointer; 
            box-shadow: 0 0 3vmin rgba(255,255,255,0.3); transition: transform 0.1s;
        }
        .start-btn:active { transform: scale(0.98); }
        .hidden { display: none !important; }

        /* MESSAGES */
        #gameMessage {
            position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%);
            font-size: 8vmin; font-weight: 900; 
            text-shadow: 0 0 2vmin rgba(0,0,0,0.8);
            pointer-events: none; z-index: 50; opacity: 0; transition: opacity 0.5s;
            text-align: center; width: 100%;
        }
        #gameMessage.show { opacity: 1; animation: pulse 0.5s infinite alternate; }
        .msg-gold { color: #facc15; text-shadow: 0 0 2vmin #a16207; }
        .msg-green { color: #4ade80; text-shadow: 0 0 2vmin #15803d; }

        /* HELP SCREEN */
        #helpScreen { background: #000; z-index: 150; overflow-y: auto; text-align: left; padding: 5vmin; align-items: flex-start; }
        .help-h1 { font-size: 6vmin; font-weight: 900; color: white; margin-bottom: 2vmin; border-bottom: 1px solid #333; width: 100%; padding-bottom: 1vmin; }
        .help-h2 { font-size: 4vmin; font-weight: bold; color: #fbbf24; margin-top: 4vmin; margin-bottom: 1vmin; }
        .help-p { font-size: 3vmin; color: #ccc; margin-bottom: 1.5vmin; line-height: 1.4; }
        .help-tag { padding: 0.2vmin 1vmin; border-radius: 0.5vmin; font-size: 2.5vmin; font-weight: bold; display: inline-block; margin-right: 0.5vmin; }
        #helpTrigger { position: absolute; top: 2vmin; right: 2vmin; width: 8vmin; height: 8vmin; border-radius: 50%; background: #333; color: white; font-weight: bold; font-size: 4vmin; display: flex; align-items: center; justify-content: center; border: 2px solid #555; cursor: pointer; z-index: 120; }

    </style>
</head>
<body>

    <div class="hud">
        <div class="hud-left">
            <div class="hearts" id="livesDisplay">❤️❤️❤️</div>
            <div id="comboContainer" class="combo-box">
                <span id="multiplierDisplay">1x</span> COMBO <span id="comboCount">0</span>
            </div>
        </div>
        <div class="hud-right">
            <div class="score" id="scoreDisplay">0</div>
            <div class="high-score">BEST: <span id="hudHighScore">0</span></div>
        </div>
    </div>
    
    <button id="pauseBtn" onclick="togglePause()">II PAUSE</button>

    <div id="gameContainer">
        <div class="col-divider"></div>
        <div class="col-divider"></div>
        <div class="col-divider" style="border:none;"></div>

        <div id="floorLine" class="absolute bottom-0 w-full bg-gradient-to-t from-red-600 to-transparent opacity-50" style="height: 1.5vmin"></div>
        <div id="particles"></div>
        <div id="gameMessage"></div>
    </div>

    <div id="controlsContainer">
        </div>

    <div id="helpScreen" class="overlay hidden">
        <h1 class="help-h1">HOW TO PLAY</h1>
        <p class="help-p">Tap notes to clear chords before they hit red.</p>
        <h2 class="help-h2">INPUTS</h2>
        <p class="help-p"><span class="help-tag" style="background:#0ea5e9">Buttons</span> Standard grid layout.</p>
        <p class="help-p"><span class="help-tag" style="background:#0ea5e9">Keys</span> Scrollable 2-octave piano. Swipe to reach high/low notes.</p>
        <h2 class="help-h2">CHORDS</h2>
        <p class="help-p"><span class="help-tag" style="background:#f43f5e">Triad</span> 3 Notes (1-3-5).</p>
        <p class="help-p"><span class="help-tag" style="background:#f43f5e">7th</span> 4 Notes (Jazz). Tap all 4!</p>
        <div class="mt-8 flex flex-col items-center w-full">
            <div class="flex items-center gap-2 mb-4">
                <input type="checkbox" id="dontShowAgain" class="w-6 h-6 rounded bg-gray-700 border-gray-600">
                <label for="dontShowAgain" class="text-white font-bold" style="font-size:3vmin">Don't show again</label>
            </div>
            <button onclick="closeHelp()" class="start-btn" style="height: 8vh; font-size: 3.5vmin;">GOT IT</button>
        </div>
    </div>

    <div id="startScreen" class="overlay">
        <div id="helpTrigger" onclick="openHelp()">?</div>
        <div class="setup-container">
            <div class="flex flex-col items-center">
                <h1 class="text-white tracking-tighter italic" style="font-size: 10vmin; font-weight: 900; line-height: 1;">CHORD<span class="text-blue-500">RAIN</span></h1>
                <p class="text-gray-400 uppercase tracking-[0.3em]" style="font-size: 2.5vmin;">Jazz Edition v4.3</p>
            </div>
            
            <div class="flex flex-col items-center w-full">
                <div class="setup-label">Select Key</div>
                <div class="key-grid" id="keySelector"></div>
            </div>

            <div class="flex gap-4 w-full justify-between">
                <div class="flex flex-col items-center" style="flex:1">
                    <div class="setup-label">Speed</div>
                    <div class="mode-toggle">
                        <button class="mode-btn" id="btnSlow" onclick="setSpeed('Slow')">SLOW</button>
                        <button class="mode-btn selected" id="btnFast" onclick="setSpeed('Fast')">FAST</button>
                    </div>
                </div>
                <div class="flex flex-col items-center" style="flex:1">
                    <div class="setup-label">Input</div>
                    <div class="mode-toggle">
                        <button class="mode-btn selected" id="btnInputButtons" onclick="setInput('Buttons')">Buttons</button>
                        <button class="mode-btn" id="btnInputKeys" onclick="setInput('Keys')">Keys</button>
                    </div>
                </div>
            </div>

            <div class="flex gap-4 w-full justify-between">
                <div class="flex flex-col items-center" style="flex:1">
                    <div class="setup-label">Mode</div>
                    <div class="mode-toggle">
                        <button class="mode-btn selected" id="btnMajor" onclick="setMode('Major')">Major</button>
                        <button class="mode-btn" id="btnMinor" onclick="setMode('Minor')">Minor</button>
                    </div>
                </div>
                <div class="flex flex-col items-center" style="flex:1">
                    <div class="setup-label">Pool</div>
                    <div class="mode-toggle">
                        <button class="mode-btn" id="btnFull" onclick="setPool('Full')">Full</button>
                        <button class="mode-btn selected" id="btnSimple" onclick="setPool('Simple')">Simple</button>
                    </div>
                </div>
            </div>

            <div class="flex gap-4 w-full justify-between">
                <div class="flex flex-col items-center" style="flex:1">
                    <div class="setup-label">Hints</div>
                    <div class="mode-toggle">
                        <button class="mode-btn" id="btnHintsOn" onclick="setHints(true)">ON</button>
                        <button class="mode-btn selected" id="btnHintsOff" onclick="setHints(false)">OFF</button>
                    </div>
                </div>
                <div class="flex flex-col items-center" style="flex:1">
                    <div class="setup-label">Extension</div>
                    <div class="mode-toggle">
                        <button class="mode-btn selected" id="btnTriad" onclick="setExt('Triad')">Triad</button>
                        <button class="mode-btn" id="btn7th" onclick="setExt('7th')">7th</button>
                    </div>
                </div>
            </div>

            <div class="flex flex-col items-center w-full">
                <button class="start-btn" onclick="startGame()">PLAY</button>
                <p class="mt-2 text-gray-600 font-mono" style="font-size: 2vmin">High Score: <span id="startHighScore">0</span></p>
            </div>
        </div>
    </div>

    <div id="pauseOverlay" class="overlay hidden">
        <h1 class="font-bold text-white mb-8" style="font-size: 6vmin">PAUSED</h1>
        <button onclick="togglePause()" class="mode-btn selected" style="margin-bottom:2vmin; width:40vmin; height: 8vmin; border-radius: 2vmin;">RESUME</button>
        <button onclick="location.reload()" class="mode-btn" style="width:40vmin; height: 8vmin; border-color:#ef4444; color:#ef4444; border-radius: 2vmin;">QUIT</button>
    </div>

    <div id="gameOverScreen" class="overlay hidden" style="justify-content: center;">
        <h1 class="font-black text-white mb-2" style="font-size: 8vmin">GAME OVER</h1>
        <p class="text-gray-400 uppercase tracking-widest mb-4" style="font-size: 2.5vmin">You Scored</p>
        <p class="text-yellow-400 font-black mb-8 drop-shadow-lg" id="finalScore" style="font-size: 15vmin">0</p>
        <button onclick="location.reload()" class="start-btn" style="width: 90vw;">PLAY AGAIN</button>
    </div>

<script>
    // --- MUSIC DATA ---
    const KEYS_FLAT = ['C', 'Db', 'D', 'Eb', 'E', 'F', 'Gb', 'G', 'Ab', 'A', 'Bb', 'B'];
    const KEYS_SHARP = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
    
    // Theoretical Sharp Keys (Major): G, D, A, E, B, F#
    const SHARP_KEYS = ['G', 'D', 'A', 'E', 'B', 'F#'];

    const INTERVALS = { 'Major': [0, 2, 4, 5, 7, 9, 11], 'Minor': [0, 2, 3, 5, 7, 8, 10] };
    const CHORD_POOLS = {
        'Major': {
            'Full': [ {deg:0,s:''}, {deg:1,s:'m'}, {deg:2,s:'m'}, {deg:3,s:''}, {deg:4,s:''}, {deg:5,s:'m'} ],
            'Simple': [ {deg:0,s:''}, {deg:3,s:''}, {deg:4,s:''} ]
        },
        'Minor': {
            'Full': [ {deg:0,s:'m'}, {deg:2,s:''}, {deg:3,s:'m'}, {deg:4,s:'m'}, {deg:5,s:''}, {deg:6,s:''} ],
            'Simple': [ {deg:0,s:'m'}, {deg:3,s:'m'}, {deg:4,s:'m'} ]
        }
    };
    const NOTE_FREQS = {
        'C': 261.63, 'C#': 277.18, 'Db': 277.18, 'D': 293.66, 'D#': 311.13, 'Eb': 311.13,
        'E': 329.63, 'F': 349.23, 'F#': 369.99, 'Gb': 369.99, 'G': 392.00, 'G#': 415.30, 'Ab': 415.30,
        'A': 440.00, 'A#': 466.16, 'Bb': 466.16, 'B': 493.88
    };

    // --- STATE ---
    let selectedKey = 'C', selectedMode = 'Major', selectedSpeed = 'Fast', selectedPool = 'Simple', selectedExt = 'Triad', selectedInput = 'Buttons';
    let hintsEnabled = false;
    let currentScaleNotes = [], activeChords = [], gameLoopId = null, isPaused = false;
    let score = 0, lives = 3, combo = 0, speedMultiplier = 0.0015; 
    let highScore = localStorage.getItem('chordRainHighScore') || 0;
    let chordsClearedTotal = 0, isBonusRound = false, bonusQueue = 0, lastColumn = -1;

    // --- HELP LOGIC ---
    function checkHelp() {
        const skip = localStorage.getItem('chordRainSkipHelp');
        if (!skip) {
            document.getElementById('helpScreen').classList.remove('hidden');
            document.getElementById('startScreen').classList.add('hidden');
        }
    }
    function closeHelp() {
        const checkbox = document.getElementById('dontShowAgain');
        if (checkbox.checked) localStorage.setItem('chordRainSkipHelp', 'true');
        document.getElementById('helpScreen').classList.add('hidden');
        document.getElementById('startScreen').classList.remove('hidden');
    }
    function openHelp() {
        document.getElementById('startScreen').classList.add('hidden');
        document.getElementById('helpScreen').classList.remove('hidden');
    }

    // --- AUDIO ---
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    let audioCtx = new AudioContext(), masterGain = audioCtx.createGain(), reverbNode = null, dryGain = audioCtx.createGain(), wetGain = audioCtx.createGain();

    function initAudio() {
        if (reverbNode) return;
        masterGain.gain.value = 0.4;
        const length = audioCtx.sampleRate * 2.5, impulse = audioCtx.createBuffer(2, length, audioCtx.sampleRate);
        for (let ch = 0; ch < 2; ch++) {
            const data = impulse.getChannelData(ch);
            for (let i = 0; i < length; i++) data[i] = (Math.random() * 2 - 1) * Math.pow(1 - i / length, 4);
        }
        reverbNode = audioCtx.createConvolver(); reverbNode.buffer = impulse;
        dryGain.gain.value = 0.8; wetGain.gain.value = 0.4;
        dryGain.connect(masterGain); wetGain.connect(reverbNode); reverbNode.connect(masterGain); masterGain.connect(audioCtx.destination);
    }

    function playNote(freq, type='triangle', duration=0.3) {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        initAudio();
        const osc = audioCtx.createOscillator(), gain = audioCtx.createGain();
        osc.type = type; osc.frequency.value = freq;
        const now = audioCtx.currentTime;
        gain.gain.setValueAtTime(0, now); gain.gain.linearRampToValueAtTime(0.5, now + 0.01); gain.gain.exponentialRampToValueAtTime(0.001, now + duration);
        osc.connect(gain); gain.connect(masterGain); osc.start(); osc.stop(now + duration);
    }

    function playChordHarmony(notes) {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        initAudio();
        notes.forEach((note, index) => {
            const freq = NOTE_FREQS[note]; if (!freq) return;
            const startTime = audioCtx.currentTime + (index * 0.015);
            const osc = audioCtx.createOscillator(), gain = audioCtx.createGain(), filter = audioCtx.createBiquadFilter();
            osc.type = 'sawtooth'; osc.frequency.value = freq; osc.detune.value = (Math.random() * 12) - 6;
            filter.type = 'lowpass'; filter.frequency.value = 850; filter.Q.value = 0.8;
            gain.gain.setValueAtTime(0, startTime); gain.gain.linearRampToValueAtTime(0.4, startTime + 0.05); gain.gain.exponentialRampToValueAtTime(0.001, startTime + 2.0);
            osc.connect(filter); filter.connect(gain); gain.connect(dryGain); gain.connect(wetGain);
            osc.start(startTime); osc.stop(startTime + 2.1);
        });
    }

    // --- UI LOGIC ---
    function initSetupScreen() {
        const container = document.getElementById('keySelector'); container.innerHTML = '';
        KEYS_FLAT.forEach(k => {
            const btn = document.createElement('div'); btn.className = `key-select-btn ${k === selectedKey ? 'selected' : ''}`;
            btn.innerText = k;
            btn.onclick = () => { selectedKey = k; document.querySelectorAll('.key-select-btn').forEach(b => b.classList.remove('selected')); btn.classList.add('selected'); };
            container.appendChild(btn);
        });
        document.getElementById('startHighScore').innerText = highScore; document.getElementById('hudHighScore').innerText = highScore;
        checkHelp();
    }

    function setMode(mode) { selectedMode = mode; updateToggle('btnMajor', mode==='Major'); updateToggle('btnMinor', mode==='Minor'); }
    function setSpeed(speed) { selectedSpeed = speed; updateToggle('btnSlow', speed==='Slow'); updateToggle('btnFast', speed==='Fast'); }
    function setHints(isEnabled) { hintsEnabled = isEnabled; updateToggle('btnHintsOn', isEnabled); updateToggle('btnHintsOff', !isEnabled); }
    function setPool(pool) { selectedPool = pool; updateToggle('btnFull', pool==='Full'); updateToggle('btnSimple', pool==='Simple'); }
    function setExt(ext) { selectedExt = ext; updateToggle('btnTriad', ext==='Triad'); updateToggle('btn7th', ext==='7th'); }
    function setInput(input) { selectedInput = input; updateToggle('btnInputButtons', input==='Buttons'); updateToggle('btnInputKeys', input==='Keys'); }
    function updateToggle(id, isActive) { document.getElementById(id).className = `mode-btn ${isActive ? 'selected' : ''}`; }

    function startGame() {
        initAudio(); currentScaleNotes = generateScaleNotes(selectedKey, selectedMode);
        generateControls();
        document.getElementById('startScreen').classList.add('hidden');
        
        score = 0; lives = 3; 
        speedMultiplier = (selectedSpeed === 'Slow') ? 0.001 : 0.0015; 
        combo = 0;
        
        activeChords = []; chordsClearedTotal = 0; isBonusRound = false; bonusQueue = 0;
        updateHUD(); spawnChord(); gameLoop();
    }

    // --- GAME ENGINE ---
    function generateScaleNotes(root, mode) {
        const rootIndex = KEYS_FLAT.indexOf(root);
        const semitones = INTERVALS[mode];
        const notes = [];
        
        const useSharps = SHARP_KEYS.includes(root);
        const sourceKeys = useSharps ? KEYS_SHARP : KEYS_FLAT;

        semitones.forEach(interval => {
            notes.push(sourceKeys[(rootIndex + interval) % 12]);
        });
        return notes;
    }

    function generateControls() {
        const container = document.getElementById('controlsContainer');
        container.innerHTML = ''; 

        if (selectedInput === 'Buttons') {
            const grid = document.createElement('div');
            grid.className = 'note-grid';
            grid.id = 'noteGrid';
            currentScaleNotes.forEach((note, index) => {
                const btn = document.createElement('div'); btn.className = 'note-btn'; btn.dataset.note = note;
                if (index === 6) btn.classList.add('span-2'); btn.textContent = note;
                const hitHandler = (e) => {
                    e.preventDefault(); if(isPaused) return;
                    btn.classList.add('pressed'); setTimeout(() => btn.classList.remove('pressed'), 100);
                    playNote(NOTE_FREQS[note] || 440, 'sine', 0.15); handleNoteInput(note);
                };
                btn.addEventListener('touchstart', hitHandler); btn.addEventListener('mousedown', hitHandler); grid.appendChild(btn);
            });
            container.appendChild(grid);
        } else {
            const kbContainer = document.createElement('div');
            kbContainer.id = 'keyboardContainer';
            const wrapper = document.createElement('div');
            wrapper.className = 'piano-wrapper';
            
            const whiteKeys = ['C', 'D', 'E', 'F', 'G', 'A', 'B'];
            const blackMap = { 'C': 'Db', 'D': 'Eb', 'F': 'Gb', 'G': 'Ab', 'A': 'Bb' };
            const blackMapSharp = { 'C': 'C#', 'D': 'D#', 'F': 'F#', 'G': 'G#', 'A': 'A#' };
            
            const useSharps = SHARP_KEYS.includes(selectedKey);
            const currentBlackMap = useSharps ? blackMapSharp : blackMap;

            for(let oct=0; oct<2; oct++) {
                whiteKeys.forEach(note => {
                    const wKey = document.createElement('div');
                    wKey.className = 'white-key';
                    wKey.dataset.note = note;
                    wKey.textContent = note;
                    
                    const hitHandler = (e) => {
                        e.preventDefault(); if(isPaused) return;
                        wKey.classList.add('pressed'); setTimeout(() => wKey.classList.remove('pressed'), 100);
                        playNote(NOTE_FREQS[note] || 440, 'sine', 0.15); handleNoteInput(note);
                    };
                    wKey.addEventListener('touchstart', hitHandler); wKey.addEventListener('mousedown', hitHandler);
                    wrapper.appendChild(wKey);

                    if (currentBlackMap[note]) {
                        const bNote = currentBlackMap[note];
                        const bKey = document.createElement('div');
                        bKey.className = 'black-key';
                        bKey.dataset.note = bNote;
                        bKey.textContent = bNote;
                        wKey.appendChild(bKey);
                        
                        const bHitHandler = (e) => {
                            e.stopPropagation(); 
                            e.preventDefault(); if(isPaused) return;
                            bKey.classList.add('pressed'); setTimeout(() => bKey.classList.remove('pressed'), 100);
                            playNote(NOTE_FREQS[bNote] || 440, 'sine', 0.15); handleNoteInput(bNote);
                        };
                        bKey.addEventListener('touchstart', bHitHandler); bKey.addEventListener('mousedown', bHitHandler);
                    }
                });
            }
            kbContainer.appendChild(wrapper);
            container.appendChild(kbContainer);
            
            setTimeout(() => {
                kbContainer.scrollLeft = kbContainer.scrollWidth / 4;
            }, 100);
        }
    }

    function togglePause() {
        isPaused = !isPaused; const ol = document.getElementById('pauseOverlay');
        if (isPaused) { ol.classList.remove('hidden'); cancelAnimationFrame(gameLoopId); } 
        else { ol.classList.add('hidden'); gameLoop(); }
    }

    function spawnChord() {
        if(isPaused) return;

        if (!isBonusRound && activeChords.length > 0) return;
        if (isBonusRound && activeChords.length > 0) {
            const newest = activeChords[activeChords.length - 1];
            if (newest.y < 0.25) { setTimeout(spawnChord, 100); return; }
        }

        const patterns = CHORD_POOLS[selectedMode][selectedPool];
        const pattern = patterns[Math.floor(Math.random() * patterns.length)];
        
        const rootIndex = pattern.deg;
        let targetNotes = [
            currentScaleNotes[rootIndex],
            currentScaleNotes[(rootIndex + 2) % 7],
            currentScaleNotes[(rootIndex + 4) % 7]
        ];
        
        let labelSuffix = pattern.s;
        if (selectedExt === '7th') {
            targetNotes.push(currentScaleNotes[(rootIndex + 6) % 7]);
            if (labelSuffix === '') {
                if (selectedMode === 'Major' && rootIndex === 4) labelSuffix = '7';
                else labelSuffix = 'maj7';
            } else if (labelSuffix === 'm') {
                labelSuffix = 'm7';
            }
        }

        let col = Math.floor(Math.random() * 3);
        while(col === lastColumn) { col = Math.floor(Math.random() * 3); }
        lastColumn = col;
        
        const positions = ['2%', '35%', '68%']; 
        const el = document.createElement('div'); 
        el.className = 'falling-chord'; 
        el.style.top = '-15%';
        el.style.left = positions[col];
        el.style.transform = 'translateX(0)';
        
        let dots = selectedExt === '7th' ? "oooo" : "ooo";

        el.innerHTML = `<span class="chord-name">${currentScaleNotes[rootIndex]}${labelSuffix}</span><span class="chord-progress" id="chordDots">${dots}</span>`;
        document.getElementById('gameContainer').appendChild(el);
        
        const newChord = { el, notes: targetNotes, progress: 0, y: -0.15, id: Date.now() + Math.random() };
        activeChords.push(newChord);
        
        if (hintsEnabled) showHints(targetNotes); 
    }

    function showHints(notes) {
        document.querySelectorAll('.hint-badge').forEach(h => h.remove()); 
        const labels = selectedExt === '7th' ? ['R', '3', '5', '7'] : ['R', '3', '5'];
        
        notes.forEach((note, i) => { 
            let btn;
            if (selectedInput === 'Buttons') {
                btn = document.querySelector(`.note-btn[data-note="${note}"]`);
            } else {
                const keys = document.querySelectorAll(`[data-note="${note}"]`);
                keys.forEach(k => {
                    const badge = document.createElement('div'); 
                    badge.className = 'hint-badge'; 
                    badge.innerText = labels[i]; 
                    k.appendChild(badge); 
                });
                return; 
            }

            if (btn) { 
                const badge = document.createElement('div'); 
                badge.className = 'hint-badge'; 
                badge.innerText = labels[i]; 
                btn.appendChild(badge); 
            } 
        });
    }

    function handleNoteInput(note) {
        if (activeChords.length === 0) return;
        const target = activeChords[0];

        if (note === target.notes[target.progress]) {
            target.progress++;
            let dots = ""; 
            const max = selectedExt === '7th' ? 4 : 3;
            for(let i=0; i<max; i++) dots += (i < target.progress) ? "●" : "o";
            target.el.querySelector('#chordDots').textContent = dots;
            
            if (target.progress >= max) chordCleared(target);
        } else {
            resetCombo(); 
            target.el.style.borderColor = 'red';
            setTimeout(() => { if(target.el && !target.el.classList.contains('danger')) target.el.style.borderColor = 'transparent'; }, 200);
        }
    }

    function showMessage(text, colorClass) {
        const msg = document.getElementById('gameMessage');
        msg.textContent = text;
        msg.className = ''; 
        msg.classList.add(colorClass);
        msg.classList.add('show');
        setTimeout(() => msg.classList.remove('show'), 2000);
    }

    function startBonusRound() {
        isBonusRound = true;
        bonusQueue = 6;
        showMessage("BONUS ROUND", "msg-gold");
        setTimeout(spawnChord, 1000);
    }

    function chordCleared(chord) {
        playChordHarmony(chord.notes);
        const rect = chord.el.getBoundingClientRect(), containerRect = document.getElementById('gameContainer').getBoundingClientRect();
        spawnParticles((rect.left - containerRect.left) + rect.width / 2, (rect.top - containerRect.top) + rect.height / 2, '#4ade80');
        
        chord.el.remove();
        activeChords = activeChords.filter(c => c.id !== chord.id);
        
        combo++; score += 10 * (1 + Math.floor(combo / 5));
        
        if (score % 50 === 0) speedMultiplier += 0.00005;
        chordsClearedTotal++;
        
        document.querySelectorAll('.hint-badge').forEach(h => h.remove());
        if(activeChords.length > 0 && hintsEnabled) showHints(activeChords[0].notes);

        updateHUD(); 

        if (isBonusRound && bonusQueue > 0) {
            if (!chord.hasTriggeredNext) {
                bonusQueue--;
                setTimeout(spawnChord, 300);
            }
        }
        
        if (isBonusRound && activeChords.length === 0 && bonusQueue === 0) {
            isBonusRound = false;
            showMessage("BONUS COMPLETE", "msg-green");
            setTimeout(spawnChord, 1500);
        }

        if (!isBonusRound) {
            if (chordsClearedTotal % 5 === 0) {
                startBonusRound();
            } else {
                setTimeout(spawnChord, 250);
            }
        }
    }

    function chordFailed(chord) {
        resetCombo(); document.body.style.backgroundColor = '#300'; setTimeout(() => document.body.style.backgroundColor = '#111', 100);
        chord.el.remove();
        activeChords = activeChords.filter(c => c.id !== chord.id);
        
        lives--; updateHUD();
        document.querySelectorAll('.hint-badge').forEach(h => h.remove());
        
        if (isBonusRound && bonusQueue > 0 && !chord.hasTriggeredNext) {
             bonusQueue--;
             setTimeout(spawnChord, 300);
        }

        if (lives <= 0) {
            endGame();
        } else {
            if (!isBonusRound && activeChords.length === 0) setTimeout(spawnChord, 500);
        }
    }

    function resetCombo() { combo = 0; updateHUD(); }

    function updateHUD() {
        document.getElementById('scoreDisplay').textContent = score;
        let heartsStr = ""; for(let i=0; i<lives; i++) heartsStr += "❤️"; document.getElementById('livesDisplay').textContent = heartsStr;
        const comboContainer = document.getElementById('comboContainer');
        document.getElementById('comboCount').textContent = combo; document.getElementById('multiplierDisplay').textContent = (1 + Math.floor(combo / 5)) + "x";
        if (combo > 1) comboContainer.classList.add('active'); else comboContainer.classList.remove('active');
    }

    function spawnParticles(x, y, color) {
        const container = document.getElementById('particles');
        for (let i = 0; i < 15; i++) {
            const p = document.createElement('div'); p.className = 'particle'; p.style.backgroundColor = color;
            p.style.left = x + 'px'; p.style.top = y + 'px';
            const angle = Math.random() * Math.PI * 2, velocity = 2 + Math.random() * 4;
            let vx = Math.cos(angle) * velocity, vy = Math.sin(angle) * velocity, life = 1.0, px = x, py = y;
            container.appendChild(p);
            const anim = () => { life -= 0.05; if(life<=0) { p.remove(); return; } px += vx; py += vy + 2; p.style.left = px + 'px'; p.style.top = py + 'px'; p.style.opacity = life; requestAnimationFrame(anim); };
            requestAnimationFrame(anim);
        }
    }

    function gameLoop() {
        if (lives <= 0 || isPaused) return;

        activeChords.forEach(chord => {
            chord.y += speedMultiplier; 
            chord.el.style.top = (chord.y * 100) + '%';
            
            const progress = chord.y + 0.1;
            if (progress < 0.5) { chord.el.style.backgroundColor = '#4ade80'; chord.el.classList.remove('danger'); }
            else if (progress < 0.75) { chord.el.style.backgroundColor = '#fbbf24'; }
            else { if (!chord.el.classList.contains('danger')) chord.el.classList.add('danger'); }
            
            if (chord.y >= 0.90) chordFailed(chord);

            if (isBonusRound && bonusQueue > 0) {
                if (chord.y > 0.55 && !chord.hasTriggeredNext) {
                    chord.hasTriggeredNext = true;
                    bonusQueue--;
                    spawnChord();
                }
            }
        });

        gameLoopId = requestAnimationFrame(gameLoop);
    }

    function endGame() {
        cancelAnimationFrame(gameLoopId);
        if (score > highScore) { highScore = score; localStorage.setItem('chordRainHighScore', highScore); }
        document.getElementById('finalScore').textContent = score; document.getElementById('gameOverScreen').classList.remove('hidden');
    }

    initSetupScreen();
</script>
</body>
</html>